<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BẢNG ĐÁNH GIÁ THƯỞNG CUỐI KỲ - REAL-TIME</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.05);
            transform: rotate(30deg);
        }
        
        .header-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
        }
        
        .header-subtitle {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.9;
            position: relative;
        }
        
        .header-info {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Main layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Card styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .card-title i {
            font-size: 22px;
        }
        
        /* Form styles */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }
        
        /* Button styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        /* Table styles */
        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table th {
            background-color: var(--light-bg);
            font-weight: 600;
            color: var(--primary-color);
            position: sticky;
            top: 0;
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        /* KPI Sections */
        .kpi-section {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--secondary-color);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .kpi-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .kpi-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .kpi-item-title {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        .kpi-reward {
            color: var(--success-color);
            font-weight: 600;
            font-size: 14px;
            background: #d4edda;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .kpi-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        /* Results section */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .result-box {
            background: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .result-box.highlight {
            border: 2px solid var(--success-color);
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e9 100%);
        }
        
        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .result-value.highlight {
            color: var(--success-color);
            font-size: 32px;
        }
        
        .currency {
            font-size: 18px;
            color: #666;
            margin-left: 4px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Employee info */
        .employee-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #d4e7fa 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px solid var(--secondary-color);
        }
        
        .employee-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .employee-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .employee-details {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .employee-detail {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* Status badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--success-color);
            color: white;
        }
        
        /* Real-time Updates Panel */
        .realtime-panel {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        .update-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .update-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--info-color);
        }
        
        .update-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .update-text {
            font-size: 14px;
            color: var(--dark-text);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Input group */
        .input-group {
            display: flex;
            align-items: center;
        }
        
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .input-group-append {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-left: none;
            padding: 0 15px;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            display: flex;
            align-items: center;
            height: 46px;
            color: #666;
        }
        
        /* Note box */
        .note-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .note-box strong {
            color: #856404;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .employee-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Sync indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sync-indicator.show {
            opacity: 1;
        }
        
        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Đang kết nối với cơ sở dữ liệu...</p>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>Đang đồng bộ dữ liệu...</span>
    </div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="header-title">BẢNG ĐÁNH GIÁ THƯỞNG CUỐI KỲ - REAL-TIME</h1>
            <p class="header-subtitle">QUY ĐỊNH THƯỞNG KPI - TÍNH THƯỞNG HOA HỒNG</p>
            <p class="header-subtitle">DỮ LIỆU ĐƯỢC ĐỒNG BỘ TỰ ĐỘNG - TẤT CẢ THIẾT BỊ CÙNG XEM</p>
            
            <div class="header-info">
                <div class="sync-status">
                    <div class="status-dot"></div>
                    <span>Đã kết nối với cơ sở dữ liệu</span>
                </div>
                <div>
                    <i class="fas fa-users"></i> 
                    <span id="totalEmployeesCount">0</span> nhân viên đã được tính thưởng
                </div>
                <div>
                    <i class="fas fa-sync-alt"></i> 
                    Cập nhật lần cuối: <span id="lastUpdateTime">-</span>
                </div>
            </div>
        </header>
        
        <!-- Current Employee Info -->
        <div class="employee-info" id="currentEmployeeInfo" style="display: none;">
            <div class="employee-info-header">
                <h3 class="employee-title">ĐANG KHAI BÁO THƯỞNG KPI</h3>
                <div class="status-badge">
                    <i class="fas fa-user-check"></i> ĐANG THỰC HIỆN
                </div>
            </div>
            <div class="employee-details">
                <div class="employee-detail">
                    <span class="detail-label">NHÂN VIÊN</span>
                    <span class="detail-value" id="currentEmployeeName">-</span>
                </div>
                <div class="employee-detail">
                    <span class="detail-label">THÁNG THƯỞNG</span>
                    <span class="detail-value" id="currentEmployeeMonth">-</span>
                </div>
                <div class="employee-detail">
                    <span class="detail-label">BỘ PHẬN</span>
                    <span class="detail-value" id="currentEmployeeDept">-</span>
                </div>
            </div>
        </div>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Column: Input Forms -->
            <div class="left-column">
                <!-- Step 1: Employee Information -->
                <div class="card" id="step1">
                    <h2 class="card-title"><i class="fas fa-user-plus"></i> BƯỚC 1: THÔNG TIN NHÂN VIÊN</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="employeeName"><i class="fas fa-user"></i> Tên nhân viên *</label>
                            <input type="text" id="employeeName" class="form-control" placeholder="Nhập họ và tên đầy đủ">
                        </div>
                        
                        <div class="form-group">
                            <label for="employeeMonth"><i class="fas fa-calendar-alt"></i> Tháng thưởng *</label>
                            <input type="month" id="employeeMonth" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="employeeDept"><i class="fas fa-building"></i> Bộ phận *</label>
                            <select id="employeeDept" class="form-control">
                                <option value="">Chọn bộ phận</option>
                                <option value="Kinh doanh thuốc">Kinh doanh thuốc</option>
                                <option value="Kinh doanh không thuốc">Kinh doanh không thuốc</option>
                                <option value="Kinh doanh tổng hợp">Kinh doanh tổng hợp</option>
                                <option value="Phát triển thị trường">Phát triển thị trường</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="employeeCode"><i class="fas fa-id-card"></i> Mã nhân viên (nếu có)</label>
                            <input type="text" id="employeeCode" class="form-control" placeholder="Nhập mã nhân viên">
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" id="saveEmployeeBtn">
                            <i class="fas fa-save"></i> LƯU THÔNG TIN & BẮT ĐẦU KHAI BÁO
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: KPI Declaration (Initially Hidden) -->
                <div class="card" id="step2" style="display: none;">
                    <h2 class="card-title"><i class="fas fa-edit"></i> BƯỚC 2: KHAI BÁO THÀNH TÍCH</h2>
                    
                    <!-- DOANH THU -->
                    <div class="kpi-section">
                        <div class="section-title">
                            <i class="fas fa-chart-line"></i> DOANH THU THÁNG
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="revenueThuoc">Doanh thu nhóm THUỐC</label>
                                <div class="input-group">
                                    <input type="number" id="revenueThuoc" class="form-control" placeholder="Nhập doanh thu" min="0" value="0">
                                    <div class="input-group-append">VNĐ</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="revenueKhongThuoc">Doanh thu nhóm KHÔNG THUỐC</label>
                                <div class="input-group">
                                    <input type="number" id="revenueKhongThuoc" class="form-control" placeholder="Nhập doanh thu" min="0" value="0">
                                    <div class="input-group-append">VNĐ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- THƯỞNG PHÁT TRIỂN KHÁCH HÀNG -->
                    <div class="kpi-section">
                        <div class="section-title">
                            <i class="fas fa-hospital-user"></i> THƯỞNG PHÁT TRIỂN KHÁCH HÀNG
                        </div>
                        
                        <div class="kpi-grid">
                            <!-- Nhóm thuốc -->
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Nhà thuốc cho THUỐC</div>
                                    <span class="kpi-reward">200,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Tổng giá trị đặt hàng ≥ 3,000,000 VNĐ</div>
                                <div class="input-group">
                                    <input type="number" id="achievement1" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">nhà thuốc</div>
                                </div>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Sản phẩm THUỐC mới</div>
                                    <span class="kpi-reward">100,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Giới thiệu SP mới, đơn hàng ≥ 1,000,000 VNĐ</div>
                                <div class="input-group">
                                    <input type="number" id="achievement2" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">sản phẩm</div>
                                </div>
                            </div>
                            
                            <!-- Nhóm không thuốc -->
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Nhà thuốc cho KHÔNG THUỐC</div>
                                    <span class="kpi-reward">400,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Tổng giá trị đặt hàng ≥ 3,000,000 VNĐ</div>
                                <div class="input-group">
                                    <input type="number" id="achievement3" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">nhà thuốc</div>
                                </div>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Sản phẩm UVS mới</div>
                                    <span class="kpi-reward">200,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Giới thiệu SP mới, đơn hàng ≥ 1,000,000 VNĐ</div>
                                <div class="input-group">
                                    <input type="number" id="achievement4" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">sản phẩm</div>
                                </div>
                            </div>
                            
                            <!-- NPP -->
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Nhà Phân Phối (NPP)</div>
                                    <span class="kpi-reward">1,000,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Tổng giá trị đặt hàng ≥ 8,000,000 VNĐ/đơn</div>
                                <div class="input-group">
                                    <input type="number" id="achievement5" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">NPP</div>
                                </div>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Sản phẩm mới vào NPP</div>
                                    <span class="kpi-reward">300,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Giới thiệu SP mới vào NPP hiện tại</div>
                                <div class="input-group">
                                    <input type="number" id="achievement6" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">sản phẩm</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- THƯỞNG MỞ RỘNG THỊ TRƯỜNG -->
                    <div class="kpi-section">
                        <div class="section-title">
                            <i class="fas fa-expand-alt"></i> THƯỞNG MỞ RỘNG THỊ TRƯỜNG
                        </div>
                        
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Mở chuỗi Nhà Thuốc mới</div>
                                    <span class="kpi-reward">800,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Lên đơn tối thiểu 5,000,000 VNĐ</div>
                                <div class="input-group">
                                    <input type="number" id="achievement7" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">chuỗi</div>
                                </div>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Mở NT trong phòng khám</div>
                                    <span class="kpi-reward">800,000 VNĐ</span>
                                </div>
                                <div class="kpi-desc">Đặt hàng ≥ 6,000,000 VNĐ</div>
                                <div class="input-group">
                                    <input type="number" id="achievement8" class="form-control" placeholder="Số lượng" min="0" value="0">
                                    <div class="input-group-append">khách hàng</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TRỪ ĐIỂM KPI -->
                    <div class="kpi-section" style="border-left-color: var(--danger-color);">
                        <div class="section-title" style="color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i> KHAI BÁO LỖI TRỪ ĐIỂM KPI
                        </div>
                        
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Lỗi nhắc nhở sai sót khai báo</div>
                                    <span class="kpi-reward" style="background: #f8d7da; color: var(--danger-color);">Trừ 5%</span>
                                </div>
                                <div class="kpi-desc">Không thực hiện khai báo đúng khi phát triển khách hàng mới</div>
                                <div class="input-group">
                                    <input type="number" id="deduction1" class="form-control" placeholder="Số lần" min="0" value="0">
                                    <div class="input-group-append">lần</div>
                                </div>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Lỗi sai sót đơn hàng</div>
                                    <span class="kpi-reward" style="background: #f8d7da; color: var(--danger-color);">Trừ 8%</span>
                                </div>
                                <div class="kpi-desc">Chiết khấu, sản lượng làm ảnh hưởng đến dữ liệu khách hàng</div>
                                <div class="input-group">
                                    <input type="number" id="deduction2" class="form-control" placeholder="Số lần" min="0" value="0">
                                    <div class="input-group-append">lần</div>
                                </div>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Lỗi báo cáo Cuối Tháng</div>
                                    <span class="kpi-reward" style="background: #f8d7da; color: var(--danger-color);">Trừ 10%</span>
                                </div>
                                <div class="kpi-desc">Trễ báo cáo hoặc phải làm lại do sai sót nhiều</div>
                                <select id="deduction3" class="form-control">
                                    <option value="0">Không vi phạm</option>
                                    <option value="1">Có vi phạm</option>
                                </select>
                            </div>
                            
                            <div class="kpi-item">
                                <div class="kpi-item-header">
                                    <div class="kpi-item-title">Lỗi không tuân thủ quy định</div>
                                    <span class="kpi-reward" style="background: #f8d7da; color: var(--danger-color);">Trừ 8%</span>
                                </div>
                                <div class="kpi-desc">Không làm đủ thủ tục giao dịch khách hàng theo quy định</div>
                                <div class="input-group">
                                    <input type="number" id="deduction4" class="form-control" placeholder="Số lần" min="0" value="0">
                                    <div class="input-group-append">lần</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="note-box">
                        <strong><i class="fas fa-info-circle"></i> GHI CHÚ:</strong><br>
                        - Hoa hồng được tính cho khách hàng do nhân viên khai thác trực tiếp<br>
                        - Doanh thu tính từ thời điểm chốt Sales thành công<br>
                        - Doanh thu tính tỉ lệ tăng trưởng là doanh thu gộp (gồm cả công nợ)<br>
                        - <strong>Dữ liệu được lưu tự động và đồng bộ real-time với tất cả thiết bị</strong>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" id="calculateBtn">
                            <i class="fas fa-calculator"></i> TÍNH TOÁN KẾT QUẢ
                        </button>
                        <button class="btn btn-warning" id="resetFormBtn">
                            <i class="fas fa-redo"></i> NHẬP LẠI TỪ ĐẦU
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Results (Initially Hidden) -->
                <div class="card" id="step3" style="display: none;">
                    <h2 class="card-title"><i class="fas fa-award"></i> BƯỚC 3: KẾT QUẢ THƯỞNG</h2>
                    
                    <div class="results-grid">
                        <div class="result-box">
                            <div class="result-label">Doanh thu thuốc</div>
                            <div class="result-value" id="resultRevenueThuoc">0<span class="currency"> VNĐ</span></div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-label">Doanh thu không thuốc</div>
                            <div class="result-value" id="resultRevenueKhongThuoc">0<span class="currency"> VNĐ</span></div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-label">Hoa hồng thuốc</div>
                            <div class="result-value" id="resultCommissionThuoc">0<span class="currency"> VNĐ</span></div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-label">Hoa hồng không thuốc</div>
                            <div class="result-value" id="resultCommissionKhongThuoc">0<span class="currency"> VNĐ</span></div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-label">Thưởng KPI</div>
                            <div class="result-value" id="resultKPIBonus">0<span class="currency"> VNĐ</span></div>
                        </div>
                        
                        <div class="result-box">
                            <div class="result-label">Tổng trừ điểm KPI</div>
                            <div class="result-value" style="color: var(--danger-color);" id="resultTotalDeduction">0%</div>
                        </div>
                        
                        <div class="result-box highlight">
                            <div class="result-label">TỔNG THƯỞNG TRƯỚC TRỪ</div>
                            <div class="result-value highlight" id="resultTotalBeforeDeduction">0<span class="currency"> VNĐ</span></div>
                        </div>
                        
                        <div class="result-box highlight">
                            <div class="result-label">THỰC NHẬN (sau trừ)</div>
                            <div class="result-value highlight" id="resultFinalAmount">0<span class="currency"> VNĐ</span></div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" id="saveResultBtn">
                            <i class="fas fa-save"></i> LƯU KẾT QUẢ VÀO HỆ THỐNG
                        </button>
                        <button class="btn btn-primary" id="newEmployeeBtn">
                            <i class="fas fa-user-plus"></i> NHÂN VIÊN TIẾP THEO
                        </button>
                        <button class="btn btn-warning" id="printResultBtn">
                            <i class="fas fa-print"></i> IN KẾT QUẢ
                        </button>
                    </div>
                </div>
                
                <!-- Saved Employees List -->
                <div class="card" id="savedEmployeesCard">
                    <h2 class="card-title"><i class="fas fa-users"></i> DANH SÁCH NHÂN VIÊN ĐÃ LƯU (REAL-TIME)</h2>
                    <div class="sync-status" style="justify-content: flex-start; margin-bottom: 15px;">
                        <div class="status-dot"></div>
                        <span>Đang đồng bộ dữ liệu với tất cả thiết bị</span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="totalEmployeesStat">0</div>
                            <div class="stat-label">TỔNG NHÂN VIÊN</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalBonusStat">0 VNĐ</div>
                            <div class="stat-label">TỔNG THƯỞNG</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="avgBonusStat">0 VNĐ</div>
                            <div class="stat-label">TRUNG BÌNH/NV</div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table" id="savedEmployeesTable">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>TÊN NHÂN VIÊN</th>
                                    <th>THÁNG</th>
                                    <th>BỘ PHẬN</th>
                                    <th>DOANH THU</th>
                                    <th>TỔNG THƯỞNG</th>
                                    <th>THỜI GIAN LƯU</th>
                                    <th>THAO TÁC</th>
                                </tr>
                            </thead>
                            <tbody id="savedEmployeesBody">
                                <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" id="exportDataBtn">
                            <i class="fas fa-file-export"></i> XUẤT EXCEL
                        </button>
                        <button class="btn btn-warning" id="refreshDataBtn">
                            <i class="fas fa-sync-alt"></i> LÀM MỚI DỮ LIỆU
                        </button>
                        <button class="btn btn-danger" id="clearAllBtn">
                            <i class="fas fa-trash-alt"></i> XÓA TẤT CẢ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Real-time Updates -->
            <div class="right-column">
                <div class="realtime-panel">
                    <!-- Statistics -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> THỐNG KÊ HỆ THỐNG</h2>
                        <div class="employee-details">
                            <div class="employee-detail">
                                <span class="detail-label">TỔNG SỐ BẢN GHI</span>
                                <span class="detail-value" id="totalRecords">0</span>
                            </div>
                            <div class="employee-detail">
                                <span class="detail-label">TỔNG DOANH THU</span>
                                <span class="detail-value" id="totalRevenue">0 VNĐ</span>
                            </div>
                            <div class="employee-detail">
                                <span class="detail-label">THÁNG NHIỀU NHẤT</span>
                                <span class="detail-value" id="topMonth">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Real-time Updates -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-bolt"></i> CẬP NHẬT REAL-TIME</h2>
                        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> Dữ liệu mới nhất từ tất cả người dùng
                        </p>
                        
                        <div class="update-list" id="realtimeUpdates">
                            <!-- Updates will be added here -->
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-rocket"></i> THAO TÁC NHANH</h2>
                        <div class="btn-group" style="margin-top: 0;">
                            <button class="btn btn-success" id="quickAddBtn">
                                <i class="fas fa-plus-circle"></i> THÊM NHANH
                            </button>
                            <button class="btn btn-info" id="viewAllBtn">
                                <i class="fas fa-list"></i> XEM TẤT CẢ
                            </button>
                            <button class="btn btn-warning" id="recentBtn">
                                <i class="fas fa-history"></i> GẦN ĐÂY
                            </button>
                        </div>
                    </div>
                    
                    <!-- Information -->
                    <div class="card" style="background: #e8f4fd;">
                        <h2 class="card-title" style="color: var(--primary-color);">
                            <i class="fas fa-database"></i> THÔNG TIN ĐỒNG BỘ
                        </h2>
                        <div style="font-size: 14px; color: #555;">
                            <p><strong>Cách hoạt động:</strong></p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>Dữ liệu được lưu trên Firebase Firestore</li>
                                <li>Tự động đồng bộ với tất cả thiết bị</li>
                                <li>Không cần đăng nhập, refresh trang</li>
                                <li>Mọi thay đổi hiển thị ngay lập tức</li>
                            </ul>
                            <p style="margin-top: 15px;">
                                <strong>Lưu ý:</strong> Tất cả người dùng đều có thể xem và chỉnh sửa dữ liệu.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCOZaONEkPrOWINRAxME-ITKG04TEqLO5g",
            authDomain: "thuong-533b0.firebaseapp.com",
            projectId: "thuong-533b0",
            storageBucket: "thuong-533b0.firebasestorage.app",
            messagingSenderId: "528257010592",
            appId: "1:528257010592:web:0b6ed0612278843366b2c5",
            measurementId: "G-LLTXTPP6WY"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Application State
        let employees = [];
        let currentEmployee = null;
        let unsubscribeEmployees = null;
        
        // Quy định thưởng
        const rewardRules = [
            { id: 1, name: "Nhà thuốc cho THUỐC", reward: 200000, field: "achievement1", minOrder: 3000000 },
            { id: 2, name: "Sản phẩm THUỐC mới", reward: 100000, field: "achievement2", minOrder: 1000000 },
            { id: 3, name: "Nhà thuốc cho KHÔNG THUỐC", reward: 400000, field: "achievement3", minOrder: 3000000 },
            { id: 4, name: "Sản phẩm UVS mới", reward: 200000, field: "achievement4", minOrder: 1000000 },
            { id: 5, name: "Nhà Phân Phối (NPP)", reward: 1000000, field: "achievement5", minOrder: 8000000 },
            { id: 6, name: "Sản phẩm mới vào NPP", reward: 300000, field: "achievement6", minOrder: 0 },
            { id: 7, name: "Mở chuỗi Nhà Thuốc mới", reward: 800000, field: "achievement7", minOrder: 5000000 },
            { id: 8, name: "Mở NT trong phòng khám", reward: 800000, field: "achievement8", minOrder: 6000000 }
        ];
        
        // Quy định hoa hồng
        const commissionRules = {
            "thuoc": [
                { min: 2500000, max: 29999999, rate: 0.015 },
                { min: 30000000, max: 69999999, rate: 0.02 },
                { min: 70000000, max: Infinity, rate: 0.03 }
            ],
            "khongThuoc": [
                { min: 2500000, max: 15999999, rate: 0.02 },
                { min: 16000000, max: 29999999, rate: 0.035 },
                { min: 30000000, max: 69999999, rate: 0.045 },
                { min: 70000000, max: Infinity, rate: 0.06 }
            ]
        };
        
        // Quy định trừ điểm
        const deductionRules = [
            { id: 1, name: "Lỗi nhắc nhở sai sót khai báo", deduction: 5, field: "deduction1" },
            { id: 2, name: "Lỗi sai sót đơn hàng", deduction: 8, field: "deduction2" },
            { id: 3, name: "Lỗi báo cáo Cuối Tháng", deduction: 10, field: "deduction3" },
            { id: 4, name: "Lỗi không tuân thủ quy định", deduction: 8, field: "deduction4" }
        ];
        
        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const syncIndicator = document.getElementById('syncIndicator');
        
        // Header elements
        const totalEmployeesCount = document.getElementById('totalEmployeesCount');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        
        // Step elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const currentEmployeeInfo = document.getElementById('currentEmployeeInfo');
        
        // Employee info elements
        const currentEmployeeName = document.getElementById('currentEmployeeName');
        const currentEmployeeMonth = document.getElementById('currentEmployeeMonth');
        const currentEmployeeDept = document.getElementById('currentEmployeeDept');
        
        // Form elements
        const employeeNameInput = document.getElementById('employeeName');
        const employeeMonthInput = document.getElementById('employeeMonth');
        const employeeDeptSelect = document.getElementById('employeeDept');
        const employeeCodeInput = document.getElementById('employeeCode');
        const saveEmployeeBtn = document.getElementById('saveEmployeeBtn');
        
        // Calculation elements
        const calculateBtn = document.getElementById('calculateBtn');
        const resetFormBtn = document.getElementById('resetFormBtn');
        
        // Result elements
        const resultRevenueThuoc = document.getElementById('resultRevenueThuoc');
        const resultRevenueKhongThuoc = document.getElementById('resultRevenueKhongThuoc');
        const resultCommissionThuoc = document.getElementById('resultCommissionThuoc');
        const resultCommissionKhongThuoc = document.getElementById('resultCommissionKhongThuoc');
        const resultKPIBonus = document.getElementById('resultKPIBonus');
        const resultTotalDeduction = document.getElementById('resultTotalDeduction');
        const resultTotalBeforeDeduction = document.getElementById('resultTotalBeforeDeduction');
        const resultFinalAmount = document.getElementById('resultFinalAmount');
        
        // Save and navigation elements
        const saveResultBtn = document.getElementById('saveResultBtn');
        const newEmployeeBtn = document.getElementById('newEmployeeBtn');
        const printResultBtn = document.getElementById('printResultBtn');
        
        // Saved employees elements
        const savedEmployeesBody = document.getElementById('savedEmployeesBody');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        
        // Statistics elements
        const totalEmployeesStat = document.getElementById('totalEmployeesStat');
        const totalBonusStat = document.getElementById('totalBonusStat');
        const avgBonusStat = document.getElementById('avgBonusStat');
        const totalRecords = document.getElementById('totalRecords');
        const totalRevenue = document.getElementById('totalRevenue');
        const topMonth = document.getElementById('topMonth');
        
        // Real-time updates elements
        const realtimeUpdates = document.getElementById('realtimeUpdates');
        
        // Quick action elements
        const quickAddBtn = document.getElementById('quickAddBtn');
        const viewAllBtn = document.getElementById('viewAllBtn');
        const recentBtn = document.getElementById('recentBtn');
        
        // Hàm định dạng số tiền
        function formatCurrency(amount) {
            if (amount === 0) return '0';
            return new Intl.NumberFormat('vi-VN').format(amount);
        }
        
        // Hàm định dạng thời gian
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays < 7) return `${diffDays} ngày trước`;
            
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Hàm hiển thị thông báo
        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            notification.className = 'notification show';
            notification.style.backgroundColor = type === 'success' ? '#28a745' : 
                                               type === 'error' ? '#dc3545' : 
                                               type === 'warning' ? '#ffc107' : '#17a2b8';
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Hàm hiển thị sync indicator
        function showSyncIndicator(message) {
            syncIndicator.querySelector('span').textContent = message;
            syncIndicator.classList.add('show');
            setTimeout(() => {
                syncIndicator.classList.remove('show');
            }, 2000);
        }
        
        // Hàm thêm update vào real-time panel
        function addRealtimeUpdate(message, type = 'info') {
            const updateItem = document.createElement('div');
            updateItem.className = 'update-item';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            updateItem.innerHTML = `
                <div class="update-time">${timeString}</div>
                <div class="update-text">${message}</div>
            `;
            
            realtimeUpdates.insertBefore(updateItem, realtimeUpdates.firstChild);
            
            // Giới hạn số lượng update hiển thị
            if (realtimeUpdates.children.length > 10) {
                realtimeUpdates.removeChild(realtimeUpdates.lastChild);
            }
            
            // Cập nhật thời gian cuối
            lastUpdateTime.textContent = timeString;
        }
        
        // Hàm setup real-time listeners
        function setupRealtimeListeners() {
            // Listen to employees collection (real-time)
            unsubscribeEmployees = db.collection('employees')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    employees = [];
                    let totalBonusAmount = 0;
                    let totalRevenueAmount = 0;
                    const monthCounts = {};
                    
                    snapshot.forEach(doc => {
                        const employee = {
                            id: doc.id,
                            ...doc.data()
                        };
                        employees.push(employee);
                        
                        if (employee.finalAmount) {
                            totalBonusAmount += employee.finalAmount;
                        }
                        
                        // Tính tổng doanh thu
                        const revenue = (employee.revenue?.thuoc || 0) + (employee.revenue?.khongThuoc || 0);
                        totalRevenueAmount += revenue;
                        
                        // Đếm số lượng theo tháng
                        if (employee.month) {
                            monthCounts[employee.month] = (monthCounts[employee.month] || 0) + 1;
                        }
                    });
                    
                    // Cập nhật bảng
                    updateSavedEmployeesTable();
                    
                    // Cập nhật thống kê
                    totalEmployeesCount.textContent = employees.length;
                    totalEmployeesStat.textContent = employees.length;
                    totalRecords.textContent = employees.length;
                    
                    totalBonusStat.textContent = `${formatCurrency(totalBonusAmount)} VNĐ`;
                    
                    if (employees.length > 0) {
                        const avgBonus = totalBonusAmount / employees.length;
                        avgBonusStat.textContent = `${formatCurrency(Math.round(avgBonus))} VNĐ`;
                    } else {
                        avgBonusStat.textContent = '0 VNĐ';
                    }
                    
                    totalRevenue.textContent = `${formatCurrency(totalRevenueAmount)} VNĐ`;
                    
                    // Tìm tháng có nhiều bản ghi nhất
                    let topMonthName = '-';
                    let maxCount = 0;
                    for (const [month, count] of Object.entries(monthCounts)) {
                        if (count > maxCount) {
                            maxCount = count;
                            topMonthName = month;
                        }
                    }
                    topMonth.textContent = topMonthName;
                    
                    showSyncIndicator('Dữ liệu đã được cập nhật');
                    addRealtimeUpdate(`Đã cập nhật ${employees.length} nhân viên`, 'success');
                }, error => {
                    console.error('Lỗi khi lắng nghe dữ liệu:', error);
                    showNotification('Lỗi kết nối dữ liệu!', 'error');
                    addRealtimeUpdate('Lỗi kết nối cơ sở dữ liệu', 'error');
                });
        }
        
        // Hàm lưu thông tin nhân viên
        saveEmployeeBtn.addEventListener('click', () => {
            const name = employeeNameInput.value.trim();
            const month = employeeMonthInput.value;
            const dept = employeeDeptSelect.value;
            const code = employeeCodeInput.value.trim();
            
            if (!name || !month || !dept) {
                showNotification('Vui lòng nhập đầy đủ thông tin nhân viên!', 'error');
                return;
            }
            
            // Tạo đối tượng nhân viên mới
            currentEmployee = {
                id: null, // sẽ được tạo khi lưu vào Firebase
                name: name,
                code: code,
                month: month,
                department: dept,
                revenue: { thuoc: 0, khongThuoc: 0 },
                commissions: { thuoc: 0, khongThuoc: 0 },
                achievements: [],
                deductions: [],
                totalBonus: 0,
                finalAmount: 0,
                totalDeduction: 0,
                createdAt: new Date().toISOString()
            };
            
            // Hiển thị thông tin nhân viên
            currentEmployeeName.textContent = name;
            currentEmployeeMonth.textContent = month;
            currentEmployeeDept.textContent = dept;
            currentEmployeeInfo.style.display = 'block';
            
            // Chuyển sang bước 2
            step1.style.display = 'none';
            step2.style.display = 'block';
            
            showNotification(`Đã lưu thông tin: ${name}. Bắt đầu khai báo thành tích!`);
            addRealtimeUpdate(`Bắt đầu khai báo cho nhân viên: ${name}`, 'info');
        });
        
        // Hàm tính toán kết quả
        calculateBtn.addEventListener('click', () => {
            if (!currentEmployee) {
                showNotification('Vui lòng lưu thông tin nhân viên trước!', 'error');
                return;
            }
            
            // Lấy doanh thu
            const revenueThuoc = parseFloat(document.getElementById('revenueThuoc').value) || 0;
            const revenueKhongThuoc = parseFloat(document.getElementById('revenueKhongThuoc').value) || 0;
            
            // Lưu doanh thu
            currentEmployee.revenue.thuoc = revenueThuoc;
            currentEmployee.revenue.khongThuoc = revenueKhongThuoc;
            
            // Tính hoa hồng thuốc
            let commissionThuoc = 0;
            if (revenueThuoc > 0) {
                const rules = commissionRules["thuoc"];
                for (let i = rules.length - 1; i >= 0; i--) {
                    if (revenueThuoc >= rules[i].min) {
                        commissionThuoc = revenueThuoc * rules[i].rate;
                        break;
                    }
                }
            }
            
            // Tính hoa hồng không thuốc
            let commissionKhongThuoc = 0;
            if (revenueKhongThuoc > 0) {
                const rules = commissionRules["khongThuoc"];
                for (let i = rules.length - 1; i >= 0; i--) {
                    if (revenueKhongThuoc >= rules[i].min) {
                        commissionKhongThuoc = revenueKhongThuoc * rules[i].rate;
                        break;
                    }
                }
            }
            
            // Lưu hoa hồng
            currentEmployee.commissions.thuoc = commissionThuoc;
            currentEmployee.commissions.khongThuoc = commissionKhongThuoc;
            
            // Tính thưởng KPI các loại
            let kpiBonus = 0;
            currentEmployee.achievements = [];
            
            rewardRules.forEach(rule => {
                const quantity = parseInt(document.getElementById(rule.field).value) || 0;
                if (quantity > 0) {
                    const total = quantity * rule.reward;
                    kpiBonus += total;
                    
                    currentEmployee.achievements.push({
                        name: rule.name,
                        quantity: quantity,
                        reward: rule.reward,
                        total: total,
                        minOrder: rule.minOrder
                    });
                }
            });
            
            // Tính trừ điểm KPI
            let totalDeduction = 0;
            currentEmployee.deductions = [];
            
            // Lỗi 1
            const deduction1 = parseInt(document.getElementById('deduction1').value) || 0;
            if (deduction1 > 0) {
                const deductionAmount = deduction1 * deductionRules[0].deduction;
                totalDeduction += deductionAmount;
                currentEmployee.deductions.push({
                    name: deductionRules[0].name,
                    times: deduction1,
                    deduction: deductionRules[0].deduction,
                    total: deductionAmount
                });
            }
            
            // Lỗi 2
            const deduction2 = parseInt(document.getElementById('deduction2').value) || 0;
            if (deduction2 > 0) {
                const deductionAmount = deduction2 * deductionRules[1].deduction;
                totalDeduction += deductionAmount;
                currentEmployee.deductions.push({
                    name: deductionRules[1].name,
                    times: deduction2,
                    deduction: deductionRules[1].deduction,
                    total: deductionAmount
                });
            }
            
            // Lỗi 3
            const deduction3 = parseInt(document.getElementById('deduction3').value) || 0;
            if (deduction3 > 0) {
                totalDeduction += deductionRules[2].deduction;
                currentEmployee.deductions.push({
                    name: deductionRules[2].name,
                    times: 1,
                    deduction: deductionRules[2].deduction,
                    total: deductionRules[2].deduction
                });
            }
            
            // Lỗi 4
            const deduction4 = parseInt(document.getElementById('deduction4').value) || 0;
            if (deduction4 > 0) {
                const deductionAmount = deduction4 * deductionRules[3].deduction;
                totalDeduction += deductionAmount;
                currentEmployee.deductions.push({
                    name: deductionRules[3].name,
                    times: deduction4,
                    deduction: deductionRules[3].deduction,
                    total: deductionAmount
                });
            }
            
            // Giới hạn trừ điểm tối đa 100%
            totalDeduction = Math.min(totalDeduction, 100);
            
            // Tính tổng thưởng
            const totalBonus = commissionThuoc + commissionKhongThuoc + kpiBonus;
            const finalAmount = totalBonus * (1 - totalDeduction / 100);
            
            // Lưu kết quả
            currentEmployee.totalBonus = totalBonus;
            currentEmployee.finalAmount = finalAmount;
            currentEmployee.totalDeduction = totalDeduction;
            
            // Hiển thị kết quả với định dạng VNĐ
            resultRevenueThuoc.innerHTML = `${formatCurrency(revenueThuoc)}<span class="currency"> VNĐ</span>`;
            resultRevenueKhongThuoc.innerHTML = `${formatCurrency(revenueKhongThuoc)}<span class="currency"> VNĐ</span>`;
            resultCommissionThuoc.innerHTML = `${formatCurrency(commissionThuoc)}<span class="currency"> VNĐ</span>`;
            resultCommissionKhongThuoc.innerHTML = `${formatCurrency(commissionKhongThuoc)}<span class="currency"> VNĐ</span>`;
            resultKPIBonus.innerHTML = `${formatCurrency(kpiBonus)}<span class="currency"> VNĐ</span>`;
            resultTotalDeduction.textContent = `${totalDeduction.toFixed(1)}%`;
            resultTotalBeforeDeduction.innerHTML = `${formatCurrency(totalBonus)}<span class="currency"> VNĐ</span>`;
            resultFinalAmount.innerHTML = `${formatCurrency(finalAmount)}<span class="currency"> VNĐ</span>`;
            
            // Chuyển sang bước 3
            step2.style.display = 'none';
            step3.style.display = 'block';
            
            showNotification('Đã tính toán kết quả thưởng!');
            addRealtimeUpdate(`Đã tính thưởng cho ${currentEmployee.name}: ${formatCurrency(finalAmount)} VNĐ`, 'success');
        });
        
        // Hàm lưu kết quả nhân viên
        saveResultBtn.addEventListener('click', async () => {
            if (!currentEmployee) {
                showNotification('Không có dữ liệu nhân viên để lưu!', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Tạo timestamp
                const timestamp = new Date();
                
                // Lưu vào Firebase
                const employeeData = {
                    ...currentEmployee,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: timestamp.toISOString()
                };
                
                let resultMessage = '';
                
                if (currentEmployee.id) {
                    // Update existing document
                    await db.collection('employees').doc(currentEmployee.id).update(employeeData);
                    resultMessage = `Đã cập nhật thông tin thưởng cho ${currentEmployee.name}`;
                } else {
                    // Create new document
                    const docRef = await db.collection('employees').add(employeeData);
                    currentEmployee.id = docRef.id;
                    resultMessage = `Đã lưu thông tin thưởng cho ${currentEmployee.name}`;
                }
                
                showNotification(resultMessage);
                addRealtimeUpdate(resultMessage, 'success');
                
            } catch (error) {
                console.error('Lỗi lưu dữ liệu:', error);
                showNotification('Lỗi lưu dữ liệu vào hệ thống!', 'error');
                addRealtimeUpdate('Lỗi lưu dữ liệu', 'error');
            } finally {
                hideLoading();
            }
        });
        
        // Hàm nhập lại từ đầu
        resetFormBtn.addEventListener('click', () => {
            if (confirm('Bạn có chắc muốn xóa tất cả dữ liệu đã nhập?')) {
                // Reset tất cả các trường nhập liệu
                document.getElementById('revenueThuoc').value = '0';
                document.getElementById('revenueKhongThuoc').value = '0';
                
                rewardRules.forEach(rule => {
                    document.getElementById(rule.field).value = '0';
                });
                
                document.getElementById('deduction1').value = '0';
                document.getElementById('deduction2').value = '0';
                document.getElementById('deduction3').value = '0';
                document.getElementById('deduction4').value = '0';
                
                showNotification('Đã xóa tất cả dữ liệu nhập!');
                addRealtimeUpdate('Đã reset form nhập liệu', 'warning');
            }
        });
        
        // Hàm khai báo nhân viên tiếp theo
        newEmployeeBtn.addEventListener('click', () => {
            // Reset form
            employeeNameInput.value = '';
            employeeDeptSelect.value = '';
            employeeCodeInput.value = '';
            
            // Reset các trường nhập liệu
            document.getElementById('revenueThuoc').value = '0';
            document.getElementById('revenueKhongThuoc').value = '0';
            
            rewardRules.forEach(rule => {
                document.getElementById(rule.field).value = '0';
            });
            
            document.getElementById('deduction1').value = '0';
            document.getElementById('deduction2').value = '0';
            document.getElementById('deduction3').value = '0';
            document.getElementById('deduction4').value = '0';
            
            // Reset current employee
            currentEmployee = null;
            
            // Ẩn các bước 2, 3 và thông tin nhân viên
            currentEmployeeInfo.style.display = 'none';
            step2.style.display = 'none';
            step3.style.display = 'none';
            
            // Hiển thị bước 1
            step1.style.display = 'block';
            
            showNotification('Sẵn sàng khai báo nhân viên mới!');
            addRealtimeUpdate('Bắt đầu khai báo nhân viên mới', 'info');
        });
        
        // Hàm cập nhật bảng nhân viên đã lưu
        function updateSavedEmployeesTable() {
            savedEmployeesBody.innerHTML = '';
            
            if (employees.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3; display: block;"></i>
                        Chưa có nhân viên nào được lưu<br>
                        <small>Dữ liệu sẽ hiển thị ngay khi có người dùng khác lưu dữ liệu</small>
                    </td>
                `;
                savedEmployeesBody.appendChild(row);
                return;
            }
            
            employees.forEach((employee, index) => {
                const totalRevenue = employee.revenue.thuoc + employee.revenue.khongThuoc;
                const timeAgo = formatTime(employee.createdAt);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${employee.name}</strong>
                        ${employee.code ? `<br><small>${employee.code}</small>` : ''}
                    </td>
                    <td>${employee.month}</td>
                    <td>${employee.department}</td>
                    <td>${formatCurrency(totalRevenue)} VNĐ</td>
                    <td><strong>${formatCurrency(employee.finalAmount || 0)} VNĐ</strong></td>
                    <td>${timeAgo}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 14px; margin: 2px;" onclick="viewEmployee('${employee.id}')" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning" style="padding: 5px 10px; font-size: 14px; margin: 2px;" onclick="editEmployee('${employee.id}')" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 14px; margin: 2px;" onclick="deleteEmployee('${employee.id}')" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                savedEmployeesBody.appendChild(row);
            });
        }
        
        // Hàm xem chi tiết nhân viên
        window.viewEmployee = async function(id) {
            try {
                const doc = await db.collection('employees').doc(id).get();
                if (doc.exists) {
                    const employee = doc.data();
                    
                    let details = `═══════════════════════════════════\n`;
                    details += `      CHI TIẾT THƯỞNG KPI\n`;
                    details += `═══════════════════════════════════\n\n`;
                    details += `👤 NHÂN VIÊN: ${employee.name}\n`;
                    details += `📅 THÁNG: ${employee.month}\n`;
                    details += `🏢 BỘ PHẬN: ${employee.department}\n`;
                    details += `${employee.code ? `🆔 MÃ NV: ${employee.code}\n` : ''}`;
                    details += `⏰ THỜI GIAN: ${formatTime(employee.createdAt)}\n`;
                    details += `\n─────────────────────────────────\n`;
                    details += `📊 DOANH THU:\n`;
                    details += `• Thuốc: ${formatCurrency(employee.revenue?.thuoc || 0)} VNĐ\n`;
                    details += `• Không thuốc: ${formatCurrency(employee.revenue?.khongThuoc || 0)} VNĐ\n`;
                    details += `• Tổng: ${formatCurrency((employee.revenue?.thuoc || 0) + (employee.revenue?.khongThuoc || 0))} VNĐ\n`;
                    details += `\n─────────────────────────────────\n`;
                    details += `💰 HOA HỒNG:\n`;
                    details += `• Thuốc: ${formatCurrency(employee.commissions?.thuoc || 0)} VNĐ\n`;
                    details += `• Không thuốc: ${formatCurrency(employee.commissions?.khongThuoc || 0)} VNĐ\n`;
                    details += `• Tổng hoa hồng: ${formatCurrency((employee.commissions?.thuoc || 0) + (employee.commissions?.khongThuoc || 0))} VNĐ\n`;
                    
                    if (employee.achievements && employee.achievements.length > 0) {
                        details += `\n─────────────────────────────────\n`;
                        details += `🏆 THƯỞNG KPI:\n`;
                        employee.achievements.forEach(ach => {
                            details += `• ${ach.name}: ${ach.quantity} × ${formatCurrency(ach.reward)} VNĐ = ${formatCurrency(ach.total)} VNĐ\n`;
                        });
                        details += `• Tổng thưởng KPI: ${formatCurrency(employee.achievements.reduce((sum, ach) => sum + (ach.total || 0), 0))} VNĐ\n`;
                    }
                    
                    if (employee.deductions && employee.deductions.length > 0) {
                        details += `\n─────────────────────────────────\n`;
                        details += `⚠️ TRỪ ĐIỂM KPI:\n`;
                        employee.deductions.forEach(ded => {
                            details += `• ${ded.name}: ${ded.times} lần × ${ded.deduction}% = ${ded.total}%\n`;
                        });
                        details += `• Tổng trừ điểm: ${employee.totalDeduction || 0}%\n`;
                    }
                    
                    details += `\n═══════════════════════════════════\n`;
                    details += `     TỔNG KẾT THƯỞNG\n`;
                    details += `═══════════════════════════════════\n`;
                    details += `📈 Tổng thưởng trước trừ: ${formatCurrency(employee.totalBonus || 0)} VNĐ\n`;
                    details += `📉 Trừ điểm KPI: ${employee.totalDeduction || 0}%\n`;
                    details += `💵 Thực nhận: ${formatCurrency(employee.finalAmount || 0)} VNĐ\n`;
                    details += `═══════════════════════════════════\n`;
                    
                    alert(details);
                    addRealtimeUpdate(`Đã xem chi tiết thưởng của ${employee.name}`, 'info');
                }
            } catch (error) {
                console.error('Lỗi xem chi tiết:', error);
                showNotification('Lỗi tải thông tin!', 'error');
            }
        };
        
        // Hàm sửa nhân viên
        window.editEmployee = async function(id) {
            try {
                const doc = await db.collection('employees').doc(id).get();
                if (doc.exists) {
                    const employee = doc.data();
                    
                    if (confirm(`Bạn có muốn sửa thông tin của ${employee.name}?`)) {
                        // Load thông tin nhân viên
                        employeeNameInput.value = employee.name;
                        employeeMonthInput.value = employee.month;
                        employeeDeptSelect.value = employee.department;
                        employeeCodeInput.value = employee.code || '';
                        
                        // Set current employee
                        currentEmployee = {
                            id: id,
                            ...employee
                        };
                        
                        // Load dữ liệu KPI
                        if (employee.revenue) {
                            document.getElementById('revenueThuoc').value = employee.revenue.thuoc || 0;
                            document.getElementById('revenueKhongThuoc').value = employee.revenue.khongThuoc || 0;
                        }
                        
                        // Hiển thị thông tin
                        currentEmployeeName.textContent = employee.name;
                        currentEmployeeMonth.textContent = employee.month;
                        currentEmployeeDept.textContent = employee.department;
                        currentEmployeeInfo.style.display = 'block';
                        
                        // Chuyển sang bước 2
                        step1.style.display = 'none';
                        step2.style.display = 'block';
                        
                        showNotification(`Đang chỉnh sửa thông tin: ${employee.name}`);
                        addRealtimeUpdate(`Đang sửa thông tin của ${employee.name}`, 'warning');
                    }
                }
            } catch (error) {
                console.error('Lỗi sửa dữ liệu:', error);
                showNotification('Lỗi sửa dữ liệu!', 'error');
            }
        };
        
        // Hàm xóa nhân viên
        window.deleteEmployee = async function(id) {
            try {
                const doc = await db.collection('employees').doc(id).get();
                if (doc.exists) {
                    const employee = doc.data();
                    
                    if (confirm(`Bạn có chắc chắn muốn xóa nhân viên ${employee.name}?`)) {
                        await db.collection('employees').doc(id).delete();
                        showNotification('Đã xóa nhân viên thành công!');
                        addRealtimeUpdate(`Đã xóa nhân viên ${employee.name}`, 'danger');
                    }
                }
            } catch (error) {
                console.error('Lỗi xóa dữ liệu:', error);
                showNotification('Lỗi xóa dữ liệu!', 'error');
            }
        };
        
        // Hàm xuất dữ liệu Excel
        exportDataBtn.addEventListener('click', async () => {
            try {
                showLoading();
                
                let csv = 'STT,Tên nhân viên,Mã NV,Tháng,Bộ phận,Doanh thu thuốc (VNĐ),Doanh thu không thuốc (VNĐ),Hoa hồng thuốc (VNĐ),Hoa hồng không thuốc (VNĐ),Thưởng KPI (VNĐ),Tổng trừ điểm (%),Tổng thưởng (VNĐ),Thực nhận (VNĐ),Thời gian tạo\n';
                
                employees.forEach((employee, index) => {
                    const kpiBonus = employee.achievements ? 
                        employee.achievements.reduce((sum, ach) => sum + (ach.total || 0), 0) : 0;
                    const totalRevenue = (employee.revenue?.thuoc || 0) + (employee.revenue?.khongThuoc || 0);
                    
                    csv += `${index + 1},"${employee.name}","${employee.code || ''}","${employee.month}","${employee.department}",`;
                    csv += `${employee.revenue?.thuoc || 0},${employee.revenue?.khongThuoc || 0},`;
                    csv += `${employee.commissions?.thuoc || 0},${employee.commissions?.khongThuoc || 0},`;
                    csv += `${kpiBonus},${employee.totalDeduction || 0},`;
                    csv += `${employee.totalBonus || 0},${employee.finalAmount || 0},`;
                    csv += `"${formatTime(employee.createdAt)}"\n`;
                });
                
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `BANG_THUONG_KPI_REALTIME_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addRealtimeUpdate(`Đã xuất ${employees.length} bản ghi ra Excel`, 'success');
                showNotification('Đã xuất dữ liệu thành công!');
            } catch (error) {
                console.error('Lỗi xuất dữ liệu:', error);
                showNotification('Lỗi xuất dữ liệu!', 'error');
            } finally {
                hideLoading();
            }
        });
        
        // Hàm xóa tất cả dữ liệu
        clearAllBtn.addEventListener('click', async () => {
            if (employees.length === 0) {
                showNotification('Không có dữ liệu để xóa!', 'error');
                return;
            }
            
            if (confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA TẤT CẢ DỮ LIỆU?\nHành động này không thể hoàn tác và sẽ xóa dữ liệu của tất cả người dùng!')) {
                try {
                    showLoading();
                    
                    // Lấy tất cả dữ liệu
                    const querySnapshot = await db.collection('employees').get();
                    
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    
                    addRealtimeUpdate(`Đã xóa ${querySnapshot.size} bản ghi`, 'danger');
                    showNotification(`Đã xóa ${querySnapshot.size} bản ghi!`);
                } catch (error) {
                    console.error('Lỗi xóa dữ liệu:', error);
                    showNotification('Lỗi xóa dữ liệu!', 'error');
                } finally {
                    hideLoading();
                }
            }
        });
        
        // Hàm refresh dữ liệu
        refreshDataBtn.addEventListener('click', () => {
            showSyncIndicator('Đang làm mới dữ liệu...');
            addRealtimeUpdate('Đang làm mới dữ liệu', 'info');
        });
        
        // Hàm in kết quả
        printResultBtn.addEventListener('click', () => {
            window.print();
            addRealtimeUpdate('Đã in báo cáo thưởng', 'info');
        });
        
        // Hàm thêm nhanh
        quickAddBtn.addEventListener('click', () => {
            // Tự động điền thông tin mẫu
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            
            employeeNameInput.value = 'Nhân viên mẫu';
            employeeMonthInput.value = `${year}-${month}`;
            employeeDeptSelect.value = 'Kinh doanh tổng hợp';
            employeeCodeInput.value = 'NV' + Date.now().toString().slice(-4);
            
            showNotification('Đã điền thông tin mẫu, vui lòng chỉnh sửa!');
            addRealtimeUpdate('Đã tạo form mẫu', 'info');
        });
        
        // Hàm xem tất cả
        viewAllBtn.addEventListener('click', () => {
            if (employees.length > 0) {
                alert(`Tổng số nhân viên đã lưu: ${employees.length}\nTổng thưởng: ${formatCurrency(employees.reduce((sum, emp) => sum + (emp.finalAmount || 0), 0))} VNĐ`);
            } else {
                alert('Chưa có dữ liệu nào được lưu.');
            }
        });
        
        // Hàm xem gần đây
        recentBtn.addEventListener('click', () => {
            if (employees.length > 0) {
                const recentEmployees = employees.slice(0, 5);
                let message = '5 NHÂN VIÊN GẦN ĐÂY NHẤT:\n\n';
                recentEmployees.forEach((emp, index) => {
                    message += `${index + 1}. ${emp.name} - ${emp.month} - ${formatCurrency(emp.finalAmount || 0)} VNĐ\n`;
                });
                alert(message);
            } else {
                alert('Chưa có dữ liệu nào được lưu.');
            }
        });
        
        // Hàm hiển thị loading
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }
        
        // Hàm ẩn loading
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Khởi tạo ứng dụng
        async function initApp() {
            try {
                showLoading();
                
                // Đặt tháng mặc định
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                employeeMonthInput.value = `${year}-${month}`;
                
                // Setup real-time listener
                setupRealtimeListeners();
                
                // Thêm welcome update
                addRealtimeUpdate('Đã kết nối với cơ sở dữ liệu real-time', 'success');
                showNotification('Đã kết nối với cơ sở dữ liệu! Dữ liệu sẽ tự động đồng bộ.');
                
                // Ẩn loading sau 1 giây
                setTimeout(() => {
                    hideLoading();
                }, 1000);
                
            } catch (error) {
                console.error('Lỗi khởi tạo ứng dụng:', error);
                showNotification('Lỗi kết nối với cơ sở dữ liệu!', 'error');
                hideLoading();
            }
        }
        
        // Khởi chạy ứng dụng
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
